static_resources:
  listeners:
    - name: listener_0
      address: { socket_address: { address: 0.0.0.0, port_value: 8081 } }
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                # CRITICAL: Set generous timeouts for Trino's long-running result streams
                stream_idle_timeout: 3600s
                request_timeout: 3600s
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: trino
                      domains: ["*"]
                      routes:
                        - match: { prefix: "/" }
                          route: 
                            cluster: trino_upstream
                            # CRITICAL: No timeout on Trino routes to allow streaming
                            timeout: 0s
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inlineCode: |
                        function envoy_on_request(request_handle)
                          -- Get user headers from original request
                          local user_id = request_handle:headers():get("x-user-id")
                          local user_email = request_handle:headers():get("x-user-email")
                          local user_roles = request_handle:headers():get("x-user-roles")
                          
                          -- Log for debugging (will appear in Envoy logs)
                          if user_id then
                            request_handle:logInfo("Lua: Found x-user-id=" .. user_id)
                          else
                            request_handle:logWarn("Lua: x-user-id header missing!")
                          end
                          
                          -- CRITICAL: Add headers with a prefix that ext_authz will forward
                          -- Envoy's ext_authz http_service forwards headers that match allowed_headers patterns
                          -- We ensure these headers are present so they get forwarded to the authorization service
                          if user_id then
                            -- Keep original headers (they should be forwarded by allowed_headers config)
                            -- Also add to Trino for after authorization
                            request_handle:headers():add("X-Trino-User", user_id)
                          end
                        end
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      transport_api_version: V3
                      with_request_body:
                        allow_partial_message: true
                        max_request_bytes: 8192
                        pack_as_bytes: false
                      failure_mode_allow: false
                      # Allow forwarding client headers to authorization service
                      allowed_headers:
                        patterns:
                          - exact: x-user-id
                          - exact: x-user-email
                          - exact: x-user-roles
                      http_service:
                        server_uri:
                          uri: http://cerbos-adapter:8080/check
                          cluster: cerbos_adapter_cluster
                          timeout: 2s
                        authorization_request:
                          headers_to_add:
                            - key: "Content-Type"
                              value: "application/json"
                        authorization_response:
                          allowed_upstream_headers:
                            patterns:
                              - exact: x-user-id
                              - exact: x-user-email
                              - exact: x-user-roles
                              - exact: x-authz
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  clusters:
    - name: trino_upstream
      connect_timeout: 2s
      type: LOGICAL_DNS
      lb_policy: ROUND_ROBIN
      # CRITICAL: Generous timeouts for Trino streaming
      common_http_protocol_options:
        idle_timeout: 3600s
        max_connection_duration: 3600s
      load_assignment:
        cluster_name: trino_upstream
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address: { socket_address: { address: trino-coordinator, port_value: 8080 } }

    - name: cerbos_adapter_cluster
      connect_timeout: 2s
      type: LOGICAL_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: cerbos_adapter_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address: { socket_address: { address: cerbos-adapter, port_value: 8080 } }

    # OPA cluster kept for parallel running/testing (not used by default)
    - name: opa_cluster
      connect_timeout: 1s
      type: LOGICAL_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: opa_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address: { socket_address: { address: opa, port_value: 8181 } }