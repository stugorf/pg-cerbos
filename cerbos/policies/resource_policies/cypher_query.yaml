apiVersion: api.cerbos.dev/v1
resourcePolicy:
  version: "default"
  resource: "cypher_query"
  importDerivedRoles:
    - graph_query_roles
  # Schema validation enabled - validates principal attributes and resource attributes
  # Note: Principal schema validates P.attr (attributes only), not top-level fields like id/roles
  schemas:
    principalSchema:
      ref: cerbos:///aml_principal.json
    resourceSchema:
      ref: cerbos:///cypher_query_resource.json
  rules:
    # ============================================================================
    # RULE 1: Admin - Full access (no conditions)
    # Reasoning: Admin should have unrestricted access to all Cypher queries
    # Test: "Admin can execute simple customer query" - PASSING
    # Test: "Admin can execute SAR query" - PASSING
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_ALLOW
      roles: ["admin"]
    
    # ============================================================================
    # RULE 2: Manager - Full access (no conditions)
    # Reasoning: Managers should have unrestricted access to all Cypher queries
    # Test: "Manager can execute simple customer query" - PASSING
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_ALLOW
      roles: ["aml_manager", "aml_manager_full"]
    
    # ============================================================================
    # DENY RULES (evaluated first, before ALLOW rules)
    # ============================================================================
    
    # ============================================================================
    # RULE 4a: DENY Case and Alert nodes for junior analysts
    # Reasoning: Junior analysts should not access Case or Alert nodes
    # Test: "Junior analyst cannot execute Case query" - PASSING
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_DENY
      roles: ["aml_analyst_junior"]
      condition:
        match:
          expr: |
            size(R.attr.node_labels.filter(l, l == "Case")) > 0 ||
            size(R.attr.node_labels.filter(l, l == "Alert")) > 0
    
    # ============================================================================
    # RULE 4b: DENY sensitive relationship types for junior analysts
    # Reasoning: Junior analysts should not access sensitive alert-related relationships
    # Test: "Junior analyst cannot execute FLAGS_CUSTOMER relationship query" - PASSING
    # Test: "Junior analyst cannot execute FROM_ALERT relationship query" - PASSING
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_DENY
      roles: ["aml_analyst_junior"]
      condition:
        match:
          expr: |
            size(R.attr.relationship_types.filter(r, r == "FLAGS_CUSTOMER")) > 0 ||
            size(R.attr.relationship_types.filter(r, r == "FLAGS_ACCOUNT")) > 0 ||
            size(R.attr.relationship_types.filter(r, r == "FROM_ALERT")) > 0
    
    # ============================================================================
    # ALLOW RULES (evaluated after DENY rules)
    # ============================================================================
    
    # ============================================================================
    # RULE 3: Junior Analyst - Basic allow with constraints
    # Reasoning: Junior analysts can execute queries with:
    #   - max_depth <= 2 (2 hops max)
    #   - No SAR nodes
    #   - Case/Alert nodes and sensitive relationships are blocked by DENY rules above
    # Test: "Junior analyst can execute simple customer query" - PASSING
    # Test: "Junior analyst can execute 2-hop query" - PASSING
    # Test: "Junior analyst cannot execute 3-hop query" - PASSING (max_depth > 2)
    # Test: "Junior analyst cannot execute SAR query" - PASSING (SAR in node_labels)
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_ALLOW
      roles: ["aml_analyst_junior"]
      condition:
        match:
          expr: |
            R.attr.max_depth <= 2 &&
            size(R.attr.node_labels.filter(l, l == "SAR")) == 0
    
    # ============================================================================
    # RULE 5: Senior Analyst - Extended access
    # Reasoning: Senior analysts can execute queries with:
    #   - max_depth <= 4 (4 hops max)
    #   - No SAR nodes
    #   - Can access Case nodes (not blocked by DENY rules - only for junior)
    #   - Can use alert-related relationships (not blocked by DENY rules - only for junior)
    # Test: "Senior analyst can execute 2-hop query" - PASSING
    # Test: "Senior analyst can execute 4-hop query" - PASSING
    # Test: "Senior analyst can execute Case query" - PASSING
    # Test: "Senior analyst can execute FLAGS_CUSTOMER relationship query" - PASSING
    # Test: "Senior analyst can execute FROM_ALERT relationship query" - PASSING
    # Test: "Senior analyst cannot execute SAR query" - PASSING (SAR in node_labels)
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_ALLOW
      roles: ["aml_analyst_senior"]
      condition:
        match:
          expr: |
            R.attr.max_depth <= 4 &&
            size(R.attr.node_labels.filter(l, l == "SAR")) == 0
    
    # ============================================================================
    # RULE 6: General Analyst (fallback for aml_analyst without derived role)
    # Reasoning: Base aml_analyst role gets limited access (same as junior)
    #   - max_depth <= 2 (2 hops max)
    #   - No SAR nodes
    #   - No Case/Alert nodes (same restrictions as junior)
    #   - No sensitive relationships (same restrictions as junior)
    #   - This provides fallback access for users with only aml_analyst role
    #   - Users with derived roles (junior/senior) will match those rules instead
    #   - Note: DENY rules for junior analysts don't apply to base aml_analyst role,
    #     so we must include these restrictions in the ALLOW condition
    # ============================================================================
    - actions: ["execute"]
      effect: EFFECT_ALLOW
      roles: ["aml_analyst"]
      condition:
        match:
          expr: |
            R.attr.max_depth <= 2 &&
            size(R.attr.node_labels.filter(l, l == "SAR")) == 0 &&
            size(R.attr.node_labels.filter(l, l == "Case")) == 0 &&
            size(R.attr.node_labels.filter(l, l == "Alert")) == 0 &&
            size(R.attr.relationship_types.filter(r, r == "FLAGS_CUSTOMER")) == 0 &&
            size(R.attr.relationship_types.filter(r, r == "FLAGS_ACCOUNT")) == 0 &&
            size(R.attr.relationship_types.filter(r, r == "FROM_ALERT")) == 0
